# Core Engine

rpg-coreライブラリにおけるCore Engineの役割と責任範囲をまとめたドキュメント

## Core Engine とは

Core Engineは、JRPGにおける**数値計算とルール判定**を担当する層です。

### 全体アーキテクチャにおける位置づけ

```text
UI（見た目・入力）
  ↓
Headless UI（選択・確認・キャンセル）
  ↓
JRPG Services（操作フロー）
  ↓
Core Engine（数値・ルール）← ★ この層
  ↓
Game State（永続可能な状態）
```

### 設計思想

Core Engineは以下の原則に従って設計されています：

- **純粋な計算とルール**: UIや操作フローに依存しない
- **状態を持たない**: Game Stateから必要なデータを受け取り、計算結果を返す
- **決定論的**: 同じ入力に対して常に同じ出力を返す
- **テスト容易**: モックや単体テストが容易に書ける
- **カスタマイズ可能**: ゲーム固有のルールに対応できる拡張性

## Core Engine の責任範囲

### ✅ Core Engine が扱うもの

- **数値計算**: ダメージ、回復量、成長値など
- **確率判定**: クリティカル、状態異常付与、ドロップなど
- **条件判定**: 装備可否、スキル使用可否、勝敗判定など
- **ステータス計算**: 基礎値 + 装備補正 + バフ/デバフ
- **ルール処理**: ゲームメカニクスの具体的な計算式

### ❌ Core Engine が扱わないもの

- **操作フロー**: コマンド選択の流れ（→ Service の責任）
- **状態管理**: ターン進行、フェーズ管理（→ Service の責任）
- **UI表現**: 表示、アニメーション（→ UI層の責任）
- **永続化**: セーブ/ロード処理（→ Save Service の責任）

---

## 機能別詳細

### 🎮 戦闘に関する計算

#### 行動順の計算
- 素早さに基づく行動順の決定
- 先制攻撃・不意打ちの判定
- 行動順補正の適用

#### ダメージ計算
- 物理攻撃のダメージ
  - 攻撃力 - 防御力を基準とした計算
  - 武器の攻撃力補正
  - クリティカルヒット判定と倍率
  - 属性相性による補正
  - ランダム要素の付与
- 魔法攻撃のダメージ
  - 魔力ベースの計算
  - 魔法防御による軽減
  - 属性相性による補正
- スキルのダメージ
  - スキル固有の倍率
  - コスト（MP、SPなど）の計算

#### 回復量の計算
- 回復スキルの効果量
  - 固定値回復
  - 割合回復
  - 最大HPに基づく回復
- アイテムによる回復
- 継続回復の計算

#### 命中・回避の判定
- 命中率の計算
- 回避率の計算
- 必中スキルの処理

#### 勝利条件・敗北条件の判定
- 全滅判定
- 逃走成功率の計算
- 特殊勝利条件の判定

---

### 📊 ステータスとキャラクターに関する計算

#### ステータス補正の計算
- 基礎ステータスの取得
- 装備による補正
- バフ/デバフによる補正
- ジョブ・クラスによる補正
- レベルによる補正
- 最終ステータスの算出

#### レベルと成長に関する計算
- 経験値の計算
  - 戦闘報酬の経験値
  - パーティへの配分
  - 経験値ボーナスの適用
- レベルアップ判定
  - 必要経験値の計算
  - レベルアップ可否の判定
- ステータス成長の計算
  - レベルアップ時の能力値上昇
  - 成長率による変動
  - ジョブ別成長補正

#### スキル習得に関する判定
- 習得条件の判定
  - レベル要件
  - ジョブ要件
  - 前提スキル要件
- スキルデータの管理
  - スキルの効果
  - 使用コスト
  - 対象範囲

#### 職業・クラスに関する計算
- 転職条件の判定
  - レベル要件
  - アイテム要件
  - クエスト完了要件
- ステータス補正の計算
  - ジョブボーナス
  - 装備可能武器・防具の判定
- 装備可否の判定
  - ジョブ制限のチェック

---

### 🎒 装備・アイテムに関する計算

#### 装備に関する判定と計算
- 装備可能条件の判定
  - レベル制限
  - ジョブ制限
  - ステータス要件
- ステータス補正の計算
  - 攻撃力・防御力の補正
  - 属性耐性の付与
  - 特殊効果の適用
- 装備効果の適用
  - セット効果
  - エンチャント効果

#### アイテムに関する計算
- アイテムの効果計算
  - 回復アイテムの効果量
  - バフアイテムの効果
  - 戦闘アイテムの効果
- 使用可能条件の判定
  - 戦闘中/フィールドでの使用可否
  - 対象条件の判定
- インベントリの更新
  - アイテム数の増減
  - 所持上限のチェック

---

### 🧠 敵とAIに関する計算

#### 敵のステータス計算
- 敵の初期ステータス設定
  - レベルに応じた能力値
  - 敵種別による補正
- 使用可能なスキルの列挙
  - スキルの使用条件チェック
  - MP/SPコストの確認

#### ドロップとリワードの計算
- ドロップ判定の計算
  - アイテムドロップ率
  - レアドロップ判定
  - ドロップ個数の決定
- 対象候補の評価
  - AI用のターゲット選定
  - 脅威度の計算
  - 優先度の算出

---

### 💫 状態異常・バフ・デバフに関する計算

#### 状態異常の付与判定
- 状態異常の付与判定
  - 基本成功率
  - 耐性による軽減
  - 確率計算
- 効果の計算
  - 毒ダメージなどの継続ダメージ
  - ステータス変動の計算
  - 行動制限の判定
- 解除条件の判定
  - ターン経過による自然解除
  - アイテム・スキルによる解除
  - 特定条件での自動解除

#### バフ・デバフの計算
- 効果量の計算
  - ステータス上昇/下降の倍率
  - 重複時の処理
  - スタック上限
- 持続時間の管理
  - 残りターン数の計算
  - 効果の延長・短縮

---

### 🛠 クラフト・強化に関する計算

#### アイテム合成
- 素材の所持チェック
  - 必要素材の確認
  - 素材の個数チェック
- 成功率の計算
  - 基本成功率
  - スキルによる補正
  - アイテムによるボーナス
- 結果アイテムの生成
  - 通常成功時のアイテム
  - 大成功時のボーナス
  - 失敗時の素材返還判定
- インベントリの更新
  - 素材の消費
  - 完成品の追加

#### 装備・キャラクター強化
- 成功率の計算
  - 強化レベルに応じた成功率
  - 安全圏の判定
  - 失敗時のペナルティ判定
- 能力値上昇の計算
  - 強化による上昇値
  - ランダム要素
  - 上限値の判定
- コストの消費処理
  - 強化素材の消費
  - お金の消費

---

### 💾 永続化と整合性

#### ゲーム状態の永続化
- 状態のシリアライズ
  - Game Stateの永続化形式への変換
  - データの圧縮
- データバージョン管理
  - バージョン番号の管理
  - 互換性のチェック
  - マイグレーション処理

---

### 🎯 シミュレーションと分析

#### 戦闘ロジックの実行
- 自動戦闘のシミュレーション
- AI行動の決定
- 戦闘結果の予測

#### 確率計算
- 各種判定の確率計算
- 期待値の算出
- 分散の計算

#### ダメージ期待値の計算
- 平均ダメージの算出
- クリティカル込みの期待値
- 最大/最小ダメージの計算

---

## 技術的考慮事項

### インターフェース設計

Core Engineは以下のような明確なインターフェースを提供します：

```typescript
interface CoreEngine {
  // ダメージ計算の例
  calculateDamage(attacker: Character, target: Character, skill: Skill): DamageResult;
  
  // 状態異常判定の例
  applyStatusEffect(target: Character, effect: StatusEffect): boolean;
  
  // レベルアップ判定の例
  checkLevelUp(character: Character, gainedExp: number): LevelUpResult;
}
```

### 拡張性

ゲーム固有のルールに対応するため、Core Engineは以下のような拡張ポイントを提供します：

- **計算式のカスタマイズ**: ダメージ計算式を変更可能
- **ルールの追加**: 新しい判定ロジックを追加可能
- **パラメータの調整**: 成長率、倍率などを調整可能

### テスト容易性

Core Engineは以下の特性により、テストが容易です：

- **純粋関数**: 副作用がなく、同じ入力に対して同じ出力
- **モック不要**: 基本的な計算はモックなしでテスト可能
- **独立性**: 他の層に依存しない

### パフォーマンス

Core Engineは以下のパフォーマンス特性を持ちます：

- **計算の軽量性**: 複雑な計算でも高速に実行
- **キャッシュ可能**: 計算結果をキャッシュ可能
- **並列処理対応**: 複数の計算を並列実行可能

---

## Service との関係

### 分離の原則

| 責任 | Service | Core Engine |
|------|---------|-------------|
| いつ | ✓ | |
| 何を | ✓ | |
| どの順で | ✓ | |
| どのように計算するか | | ✓ |
| どんな結果になるか | | ✓ |

### 呼び出しの流れ

```text
1. Service が操作フローを管理
   ↓
2. 必要なタイミングで Core Engine を呼び出し
   ↓
3. Core Engine が計算・判定を実行
   ↓
4. 結果を Service が受け取り
   ↓
5. Service が次の状態へ遷移
```

### 具体例：戦闘でのダメージ処理

```text
【Service の責任】
- プレイヤーが攻撃コマンドを選択
- 対象の敵を選択
- コマンドの実行タイミングを管理
- 結果をUIに通知

【Core Engine の責任】
- 攻撃力と防御力からダメージを計算
- クリティカル判定
- 属性相性の補正
- 最終ダメージ値の算出
```

---

## まとめ

Core Engineは、rpg-coreライブラリにおける**計算とルールの中核**を担う層です。

### 核心的な役割

1. **純粋な計算**: 数値計算とルール判定に特化
2. **UIフリー**: 表示や操作フローから完全に独立
3. **決定論的**: テストとデバッグが容易
4. **拡張可能**: ゲーム固有のルールに対応

### 利用のメリット

- **開発効率**: 複雑な計算ロジックを再利用可能
- **テスト容易性**: 単体テストで品質を担保
- **バランス調整**: 計算式を一箇所で管理・調整
- **移植性**: 異なるプラットフォームでも同じロジックを利用

Core Engineを適切に設計することで、JRPGのゲームメカニクスを堅牢かつ保守性の高い形で実装できます。

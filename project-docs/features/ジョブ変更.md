# ジョブ変更システム設計

職業・クラスの変更に関する設計。Core Engine、Service、Headless UIの3層で構成。

## 目次

1. [概要](#概要)
2. [Core Engine層](#core-engine層)
3. [Service層](#service層)
4. [Headless UI層](#headless-ui層)

---

## 概要

### 3層アーキテクチャ

```
┌─────────────────────────────────────┐
│  Headless UI Layer                  │
│  Controller                         │  ← UI状態管理、ユーザー操作
└─────────────────────────────────────┘
              ↓ 委譲
┌─────────────────────────────────────┐
│  Service Layer                      │
│  Service                            │  ← ビジネスロジック
└─────────────────────────────────────┘
              ↓ 委譲
┌─────────────────────────────────────┐
│  Core Engine Layer                  │
│  モジュール                          │  ← 純粋な計算
└─────────────────────────────────────┘
```

---

## Core Engine層

#### 職業・クラスに関する計算
- 転職条件の判定
  - レベル要件
  - アイテム要件
  - クエスト完了要件
- ステータス補正の計算
  - ジョブボーナス
  - 装備可能武器・防具の判定
- 装備可否の判定
  - ジョブ制限のチェック


---

## Service層

---

## 7. JobChangeService - 職業・クラス変更

### 概要
キャラクターのジョブ変更の流れを管理。変更条件チェック、ジョブ変更処理を行う。

### 公開インターフェース

```typescript
class JobChangeService {
  // 転職可能ジョブ取得
  getAvailableJobs(character: Character): Job[];
  
  // 転職条件チェック
  checkJobChangeCondition(character: Character, targetJob: Job): JobChangeConditionCheck;
  
  // ジョブ変更実行
  changeJob(character: Character, targetJob: Job): JobChangeResult;
}
```

### Core Engine 委譲

- `character/job.getAvailableJobs()` - 転職可能ジョブ
- `character/job.checkJobChangeCondition()` - 転職条件判定
- `character/job.calculateJobStatModifier()` - ジョブステータス補正
- `character/stats.calculateFinalStats()` - 最終ステータス再計算

### 実装例

```typescript
class JobChangeService {
  constructor(private coreEngine: CoreEngine) {}
  
  getAvailableJobs(character: Character): Job[] {
    // Core Engineから転職可能なジョブを取得
    return this.coreEngine.getAvailableJobs(character);
  }
  
  checkJobChangeCondition(character: Character, targetJob: Job): JobChangeConditionCheck {
    // Core Engineで条件チェック
    return this.coreEngine.checkJobChangeCondition(character, targetJob);
  }
  
  changeJob(character: Character, targetJob: Job): JobChangeResult {
    // 条件チェック
    const check = this.checkJobChangeCondition(character, targetJob);
    if (!check.canChange) {
      return {
        success: false,
        message: '転職条件を満たしていません',
        missingConditions: check.missingConditions
      };
    }
    
    const previousJob = character.job;
    
    // ジョブ変更前のステータスを保存
    const previousStats = { ...character.stats };
    
    // ジョブ変更
    character.job = targetJob;
    
    // ステータス再計算
    character.stats = this.coreEngine.calculateFinalStats(character);
    
    // スキルの獲得・喪失
    const gainedSkills = targetJob.defaultSkills.filter(
      skill => !character.skills.find(s => s.id === skill.id)
    );
    const lostSkills = previousJob.defaultSkills.filter(
      skill => !targetJob.defaultSkills.find(s => s.id === skill.id)
    );
    
    // ジョブ固有スキルの更新
    character.skills = character.skills.filter(
      skill => !lostSkills.find(s => s.id === skill.id)
    );
    character.skills.push(...gainedSkills);
    
    return {
      success: true,
      message: `${targetJob.name}に転職しました！`,
      previousJob,
      newJob: targetJob,
      statChanges: {
        attack: character.stats.attack - previousStats.attack,
        defense: character.stats.defense - previousStats.defense,
        magicAttack: character.stats.magicAttack - previousStats.magicAttack,
        magicDefense: character.stats.magicDefense - previousStats.magicDefense,
        speed: character.stats.speed - previousStats.speed
      },
      gainedSkills,
      lostSkills
    };
  }
}
```



---

## Headless UI層

---

## 12. JobChangeController - 職業変更UI制御

### 状態定義

```typescript
interface JobChangeUIState {
  // 対象キャラクター
  character: Character | null;
  
  // 選択段階
  stage: 'selecting-job' | 'confirming' | 'completed';
  
  // ジョブ
  currentJob: Job | null;
  availableJobs: Job[];
  selectedJob: Job | null;
  
  // 条件
  jobChangeCondition: JobChangeConditionCheck | null;
  
  // プレビュー
  previewStats: Stats | null;
  statChanges: StatChanges | null;
  newSkills: Skill[];
  lostSkills: Skill[];
  
  // カーソル
  cursorIndex: number;
  
  // 結果
  result: JobChangeResult | null;
}

interface JobChangeConditionCheck {
  job: Job;
  canChange: boolean;
  conditions: {
    type: 'level' | 'prerequisite-job' | 'item' | 'quest';
    met: boolean;
    requirement: string;
    current: string;
  }[];
}

interface StatChanges {
  hp: number;
  mp: number;
  attack: number;
  defense: number;
  magic: number;
  speed: number;
}

interface JobChangeResult {
  success: boolean;
  character: Character;
  oldJob: Job;
  newJob: Job;
  statChanges: StatChanges;
  gainedSkills: Skill[];
  lostSkills: Skill[];
  message: string;
}
```

### コントローラー実装

```typescript
type JobChangeEvents = {
  'job-selected': { job: Job };
  'job-changed': { result: JobChangeResult };
  'cancelled': {};
};

class JobChangeController {
  private state: ObservableState<JobChangeUIState>;
  private events: EventEmitter<JobChangeEvents>;
  private service: JobChangeService;
  
  constructor(service: JobChangeService) {
    this.service = service;
    this.state = new ObservableState<JobChangeUIState>({
      character: null,
      stage: 'selecting-job',
      currentJob: null,
      availableJobs: [],
      selectedJob: null,
      jobChangeCondition: null,
      previewStats: null,
      statChanges: null,
      newSkills: [],
      lostSkills: [],
      cursorIndex: 0,
      result: null
    });
    this.events = new EventEmitter<JobChangeEvents>();
  }
  
  subscribe(listener: (state: JobChangeUIState) => void): () => void {
    return this.state.subscribe(listener);
  }
  
  on<K extends keyof JobChangeEvents>(
    event: K,
    listener: (data: JobChangeEvents[K]) => void
  ): () => void {
    return this.events.on(event, listener);
  }
  
  // 職業変更開始
  startJobChange(character: Character): void {
    const availableJobs = this.service.getAvailableJobs(character);
    
    this.state.setState({
      character,
      stage: 'selecting-job',
      currentJob: character.job,
      availableJobs,
      selectedJob: null,
      jobChangeCondition: null,
      previewStats: null,
      statChanges: null,
      newSkills: [],
      lostSkills: [],
      cursorIndex: 0,
      result: null
    });
  }
  
  // ジョブ選択
  selectJob(job: Job): void {
    const character = this.state.getState().character!;
    
    // 変更条件チェック
    const condition = this.service.checkJobChangeCondition(character, job);
    
    // ステータスプレビュー
    const previewStats = this.calculatePreviewStats(character, job);
    const statChanges = this.calculateStatChanges(character, job);
    
    // スキル変更予測
    const newSkills = this.getNewSkills(character, job);
    const lostSkills = this.getLostSkills(character, job);
    
    this.state.setState(prev => ({
      ...prev,
      selectedJob: job,
      jobChangeCondition: condition as JobChangeConditionCheck,
      previewStats,
      statChanges,
      newSkills,
      lostSkills
    }));
    
    this.events.emit('job-selected', { job });
  }
  
  // 確認画面へ
  moveToConfirming(): void {
    this.state.setState(prev => ({
      ...prev,
      stage: 'confirming'
    }));
  }
  
  // ジョブ変更実行
  async changeJob(): Promise<void> {
    const character = this.state.getState().character!;
    const job = this.state.getState().selectedJob!;
    
    const result = this.service.changeJob(character, job);
    
    this.state.setState(prev => ({
      ...prev,
      stage: 'completed',
      result: result as JobChangeResult,
      currentJob: job
    }));
    
    this.events.emit('job-changed', { result: result as JobChangeResult });
  }
  
  // カーソル移動
  moveCursor(delta: number): void {
    const maxIndex = this.state.getState().availableJobs.length - 1;
    const currentIndex = this.state.getState().cursorIndex;
    const newIndex = Math.max(0, Math.min(maxIndex, currentIndex + delta));
    
    this.state.setState(prev => ({
      ...prev,
      cursorIndex: newIndex
    }));
  }
  
  // キャンセル
  cancel(): void {
    const currentState = this.state.getState();
    
    if (currentState.stage === 'confirming') {
      this.state.setState(prev => ({
        ...prev,
        stage: 'selecting-job'
      }));
    } else {
      this.events.emit('cancelled', {});
    }
  }
  
  // ユーティリティ
  private calculatePreviewStats(character: Character, job: Job): Stats {
    // Serviceを通じて新しいステータスを計算
    const baseStats = character.stats;
    const jobModifier = job.statModifiers;
    
    return {
      maxHp: baseStats.maxHp + jobModifier.hp,
      maxMp: baseStats.maxMp + jobModifier.mp,
      attack: baseStats.attack + jobModifier.attack,
      defense: baseStats.defense + jobModifier.defense,
      magic: baseStats.magic + jobModifier.magic,
      speed: baseStats.speed + jobModifier.speed
    };
  }
  
  private calculateStatChanges(character: Character, job: Job): StatChanges {
    const currentStats = character.stats;
    const previewStats = this.calculatePreviewStats(character, job);
    
    return {
      hp: previewStats.maxHp - currentStats.maxHp,
      mp: previewStats.maxMp - currentStats.maxMp,
      attack: previewStats.attack - currentStats.attack,
      defense: previewStats.defense - currentStats.defense,
      magic: previewStats.magic - currentStats.magic,
      speed: previewStats.speed - currentStats.speed
    };
  }
  
  private getNewSkills(character: Character, job: Job): Skill[] {
    // ジョブ固有スキルから、まだ持っていないものを取得
    return job.skills.filter(skill => 
      !character.skills.some(s => s.id === skill.id)
    );
  }
  
  private getLostSkills(character: Character, job: Job): Skill[] {
    // 現在のジョブ固有スキルで、新ジョブでは使えなくなるものを取得
    const currentJobSkills = character.job.skills;
    return currentJobSkills.filter(skill => 
      !job.skills.some(s => s.id === skill.id)
    );
  }
}
```

### 使用例（React）

```typescript
function JobChangeScreen({ character }: { character: Character }) {
  const [state, setState] = useState<JobChangeUIState>();
  const controllerRef = useRef<JobChangeController>();
  
  useEffect(() => {
    const service = new JobChangeService(coreEngine);
    const controller = new JobChangeController(service);
    controllerRef.current = controller;
    
    const unsubscribe = controller.subscribe(setState);
    
    controller.startJobChange(character);
    
    return unsubscribe;
  }, [character]);
  
  if (!state) return <div>Loading...</div>;
  
  return (
    <div className="job-change-screen">
      <CharacterInfo character={state.character!} currentJob={state.currentJob} />
      
      {state.stage === 'selecting-job' && (
        <>
          <JobList
            jobs={state.availableJobs}
            cursorIndex={state.cursorIndex}
            onSelectJob={(job) => controllerRef.current?.selectJob(job)}
          />
          
          {state.selectedJob && (
            <JobPreview
              job={state.selectedJob}
              condition={state.jobChangeCondition}
              statChanges={state.statChanges}
              newSkills={state.newSkills}
              lostSkills={state.lostSkills}
              onConfirm={() => controllerRef.current?.moveToConfirming()}
            />
          )}
        </>
      )}
      
      {state.stage === 'confirming' && (
        <ConfirmDialog
          message={`${state.selectedJob?.name}に転職しますか？`}
          onConfirm={() => controllerRef.current?.changeJob()}
          onCancel={() => controllerRef.current?.cancel()}
        />
      )}
      
      {state.stage === 'completed' && state.result && (
        <JobChangeResult result={state.result} />
      )}
    </div>
  );
}
```



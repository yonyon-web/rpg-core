# 強化システム設計

装備・キャラクターの強化に関する設計。Core Engine、Service、Headless UIの3層で構成。

## 目次

1. [概要](#概要)
2. [Core Engine層](#core-engine層)
3. [Service層](#service層)
4. [Headless UI層](#headless-ui層)

---

## 概要

### 3層アーキテクチャ

```
┌─────────────────────────────────────┐
│  Headless UI Layer                  │
│  Controller                         │  ← UI状態管理、ユーザー操作
└─────────────────────────────────────┘
              ↓ 委譲
┌─────────────────────────────────────┐
│  Service Layer                      │
│  Service                            │  ← ビジネスロジック
└─────────────────────────────────────┘
              ↓ 委譲
┌─────────────────────────────────────┐
│  Core Engine Layer                  │
│  モジュール                          │  ← 純粋な計算
└─────────────────────────────────────┘
```

---

## Core Engine層

#### 装備・キャラクター強化
- 成功率の計算
  - 強化レベルに応じた成功率
  - 安全圏の判定
  - 失敗時のペナルティ判定
- 能力値上昇の計算
  - 強化による上昇値
  - ランダム要素
  - 上限値の判定
- コストの消費処理
  - 強化素材の消費
  - お金の消費


---

## Service層

---

## 14. EnhanceService - 装備・キャラ強化

### 概要
装備やキャラクターの強化を管理。強化実行、成功判定を行う。

### 公開インターフェース

```typescript
class EnhanceService {
  // 強化実行
  enhance(target: EnhanceTarget, materials: Item[]): EnhanceResult;
  
  // 強化コスト計算
  calculateCost(target: EnhanceTarget, currentLevel: number): EnhanceCost;
  
  // 成功率取得
  getSuccessRate(target: EnhanceTarget, currentLevel: number): number;
}
```

### Core Engine 委譲

- `craft/enhance.calculateEnhanceSuccessRate()` - 成功率計算
- `craft/enhance.rollEnhanceResult()` - 強化結果判定
- `craft/enhance.calculateEnhanceBonus()` - 強化ボーナス計算
- `craft/enhance.calculateEnhanceCost()` - コスト計算

### 実装例

```typescript
class EnhanceService {
  constructor(
    private coreEngine: CoreEngine,
    private inventoryService: InventoryService
  ) {}
  
  getSuccessRate(target: EnhanceTarget, currentLevel: number): number {
    // Core Engineで成功率を計算
    return this.coreEngine.calculateEnhanceSuccessRate(target, currentLevel);
  }
  
  calculateCost(target: EnhanceTarget, currentLevel: number): EnhanceCost {
    // Core Engineでコストを計算
    return this.coreEngine.calculateEnhanceCost(target, currentLevel);
  }
  
  enhance(target: EnhanceTarget, materials: Item[]): EnhanceResult {
    const currentLevel = target.enhanceLevel || 0;
    
    // コスト計算
    const cost = this.calculateCost(target, currentLevel);
    
    // 材料チェック
    for (const material of cost.requiredMaterials) {
      if (!this.inventoryService.hasItem(material.item.id, material.quantity)) {
        return {
          success: false,
          failed: false,
          message: `${material.item.name}が不足しています`
        };
      }
    }
    
    // お金チェック
    // if (gameState.money < cost.money) {
    //   return { success: false, failed: false, message: 'お金が不足しています' };
    // }
    
    // 成功率取得
    const successRate = this.getSuccessRate(target, currentLevel);
    
    // 材料・お金消費
    for (const material of cost.requiredMaterials) {
      this.inventoryService.removeItem(material.item, material.quantity);
    }
    // gameState.money -= cost.money;
    
    // 強化判定
    const result = this.coreEngine.rollEnhanceResult(target, successRate);
    
    if (result.success) {
      // 成功：強化レベルアップ
      const previousLevel = currentLevel;
      target.enhanceLevel = currentLevel + 1;
      
      // ボーナス計算
      const bonus = this.coreEngine.calculateEnhanceBonus(target, target.enhanceLevel);
      
      // 装備の場合はステータスを更新
      if ('stats' in target) {
        (target as Equipment).stats = {
          ...((target as Equipment).stats || {}),
          attack: ((target as Equipment).stats?.attack || 0) + (bonus.attack || 0),
          defense: ((target as Equipment).stats?.defense || 0) + (bonus.defense || 0),
          magicAttack: ((target as Equipment).stats?.magicAttack || 0) + (bonus.magicAttack || 0),
          magicDefense: ((target as Equipment).stats?.magicDefense || 0) + (bonus.magicDefense || 0)
        };
      }
      
      return {
        success: true,
        failed: false,
        message: `強化に成功しました！ +${target.enhanceLevel}`,
        newLevel: target.enhanceLevel,
        previousLevel,
        bonus,
        wasGreatSuccess: result.wasGreatSuccess
      };
    } else {
      // 失敗
      if (result.destroyed) {
        // 破壊
        // target を削除する処理が必要
        return {
          success: false,
          failed: true,
          destroyed: true,
          message: '強化に失敗し、装備が破壊されました...'
        };
      } else if (result.levelDown) {
        // レベルダウン
        const previousLevel = currentLevel;
        target.enhanceLevel = Math.max(0, currentLevel - 1);
        
        return {
          success: false,
          failed: true,
          levelDown: true,
          message: `強化に失敗し、強化レベルが下がりました（+${previousLevel} → +${target.enhanceLevel}）`,
          newLevel: target.enhanceLevel,
          previousLevel
        };
      } else {
        // 失敗（レベル維持）
        return {
          success: false,
          failed: true,
          message: '強化に失敗しましたが、強化レベルは維持されました'
        };
      }
    }
  }
}
```



---

## Headless UI層

---

## 10. EnhanceController - 強化UI制御

### 状態定義

```typescript
interface EnhanceUIState {
  // 段階
  stage: 'selecting-target' | 'selecting-materials' | 'confirming' | 'enhancing' | 'completed';
  
  // 強化対象
  enhanceTarget: EnhanceTarget | null;
  targetType: 'equipment' | 'character';
  
  // 材料
  availableMaterials: Item[];
  selectedMaterials: Item[];
  
  // 強化情報
  currentLevel: number;
  maxLevel: number;
  cost: EnhanceCost | null;
  successRate: number;
  
  // プレビュー
  previewStats: any | null;
  
  // 結果
  result: EnhanceResult | null;
  isProcessing: boolean;
  
  // カーソル
  cursorIndex: number;
}

interface EnhanceTarget {
  id: string;
  name: string;
  type: 'equipment' | 'character';
  currentLevel: number;
}

interface EnhanceCost {
  money: number;
  materials: { item: Item; quantity: number }[];
}

interface EnhanceResult {
  success: boolean;
  target: EnhanceTarget;
  oldLevel: number;
  newLevel: number;
  bonusApplied?: any;
  message: string;
}
```

### コントローラー実装

```typescript
type EnhanceEvents = {
  'target-selected': { target: EnhanceTarget };
  'materials-selected': { materials: Item[] };
  'enhance-started': { target: EnhanceTarget };
  'enhance-completed': { result: EnhanceResult };
  'cancelled': {};
};

class EnhanceController {
  private state: ObservableState<EnhanceUIState>;
  private events: EventEmitter<EnhanceEvents>;
  private service: EnhanceService;
  
  constructor(service: EnhanceService) {
    this.service = service;
    this.state = new ObservableState<EnhanceUIState>({
      stage: 'selecting-target',
      enhanceTarget: null,
      targetType: 'equipment',
      availableMaterials: [],
      selectedMaterials: [],
      currentLevel: 0,
      maxLevel: 10,
      cost: null,
      successRate: 0,
      previewStats: null,
      result: null,
      isProcessing: false,
      cursorIndex: 0
    });
    this.events = new EventEmitter<EnhanceEvents>();
  }
  
  subscribe(listener: (state: EnhanceUIState) => void): () => void {
    return this.state.subscribe(listener);
  }
  
  on<K extends keyof EnhanceEvents>(
    event: K,
    listener: (data: EnhanceEvents[K]) => void
  ): () => void {
    return this.events.on(event, listener);
  }
  
  // 強化開始
  startEnhance(targetType: 'equipment' | 'character'): void {
    this.state.setState({
      stage: 'selecting-target',
      enhanceTarget: null,
      targetType,
      availableMaterials: [],
      selectedMaterials: [],
      currentLevel: 0,
      maxLevel: 10,
      cost: null,
      successRate: 0,
      previewStats: null,
      result: null,
      isProcessing: false,
      cursorIndex: 0
    });
  }
  
  // 対象選択
  selectTarget(target: EnhanceTarget): void {
    // コスト計算
    const cost = this.service.calculateCost(target, target.currentLevel);
    
    // 成功率取得
    const successRate = this.service.getSuccessRate(target, target.currentLevel);
    
    // 利用可能な材料取得
    const availableMaterials = this.getAvailableMaterials();
    
    this.state.setState(prev => ({
      ...prev,
      enhanceTarget: target,
      currentLevel: target.currentLevel,
      cost: cost as EnhanceCost,
      successRate,
      availableMaterials,
      stage: 'selecting-materials'
    }));
    
    this.events.emit('target-selected', { target });
  }
  
  // 材料選択
  selectMaterial(material: Item): void {
    const currentMaterials = this.state.getState().selectedMaterials;
    
    // 材料を追加
    this.state.setState(prev => ({
      ...prev,
      selectedMaterials: [...currentMaterials, material]
    }));
    
    // 成功率再計算（材料によってボーナスがある場合）
    this.updateSuccessRate();
  }
  
  // 材料削除
  removeMaterial(index: number): void {
    const currentMaterials = this.state.getState().selectedMaterials;
    const newMaterials = currentMaterials.filter((_, i) => i !== index);
    
    this.state.setState(prev => ({
      ...prev,
      selectedMaterials: newMaterials
    }));
    
    this.updateSuccessRate();
  }
  
  // 成功率更新
  private updateSuccessRate(): void {
    const target = this.state.getState().enhanceTarget!;
    const materials = this.state.getState().selectedMaterials;
    
    // 基本成功率
    let successRate = this.service.getSuccessRate(target, target.currentLevel);
    
    // 材料ボーナス計算
    const materialBonus = materials.reduce((bonus, mat) => {
      return bonus + (mat.enhanceBonus || 0);
    }, 0);
    
    successRate = Math.min(100, successRate + materialBonus);
    
    this.state.setState(prev => ({
      ...prev,
      successRate
    }));
  }
  
  // 確認画面へ
  moveToConfirming(): void {
    this.state.setState(prev => ({
      ...prev,
      stage: 'confirming'
    }));
  }
  
  // 強化実行
  async enhance(): Promise<void> {
    const target = this.state.getState().enhanceTarget!;
    const materials = this.state.getState().selectedMaterials;
    
    this.state.setState(prev => ({
      ...prev,
      stage: 'enhancing',
      isProcessing: true
    }));
    
    this.events.emit('enhance-started', { target });
    
    // 強化演出待機
    await this.wait(2000);
    
    const result = this.service.enhance(target, materials);
    
    this.state.setState(prev => ({
      ...prev,
      stage: 'completed',
      result: result as EnhanceResult,
      isProcessing: false
    }));
    
    this.events.emit('enhance-completed', { result: result as EnhanceResult });
  }
  
  // カーソル移動
  moveCursor(delta: number): void {
    const currentState = this.state.getState();
    let maxIndex = 0;
    
    if (currentState.stage === 'selecting-materials') {
      maxIndex = currentState.availableMaterials.length - 1;
    }
    
    const newIndex = Math.max(0, Math.min(maxIndex, currentState.cursorIndex + delta));
    
    this.state.setState(prev => ({
      ...prev,
      cursorIndex: newIndex
    }));
  }
  
  // キャンセル
  cancel(): void {
    const currentState = this.state.getState();
    
    if (currentState.stage === 'selecting-materials') {
      this.state.setState(prev => ({
        ...prev,
        stage: 'selecting-target'
      }));
    } else if (currentState.stage === 'confirming') {
      this.state.setState(prev => ({
        ...prev,
        stage: 'selecting-materials'
      }));
    } else {
      this.events.emit('cancelled', {});
    }
  }
  
  private getAvailableMaterials(): Item[] {
    // インベントリから強化材料を取得
    return [];
  }
  
  private wait(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```



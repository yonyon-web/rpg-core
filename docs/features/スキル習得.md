# スキル習得システム設計

スキルの習得管理に関する設計。Core Engine、Service、Headless UIの3層で構成。

## 目次

1. [概要](#概要)
2. [Core Engine層](#core-engine層)
3. [Service層](#service層)
4. [Headless UI層](#headless-ui層)

---

## 概要

### 3層アーキテクチャ

```
┌─────────────────────────────────────┐
│  Headless UI Layer                  │
│  Controller                         │  ← UI状態管理、ユーザー操作
└─────────────────────────────────────┘
              ↓ 委譲
┌─────────────────────────────────────┐
│  Service Layer                      │
│  Service                            │  ← ビジネスロジック
└─────────────────────────────────────┘
              ↓ 委譲
┌─────────────────────────────────────┐
│  Core Engine Layer                  │
│  モジュール                          │  ← 純粋な計算
└─────────────────────────────────────┘
```

---

## Core Engine層

このシステムのCore Engine層の実装は他のモジュールを参照してください。

---

## Service層

---

## 6. SkillLearnService - スキル習得管理

### 概要
キャラクターのスキル習得の流れを管理。習得条件チェック、習得処理を行う。

### 状態管理

```typescript
interface SkillLearnState {
  // 対象キャラクター
  character: Character;
  
  // 習得可能スキル
  learnableSkills: Skill[];
  
  // 選択中のスキル
  selectedSkill?: Skill;
  
  // コスト
  cost?: number;
}
```

### 公開インターフェース

```typescript
class SkillLearnService {
  // 習得可能スキル取得
  getLearnableSkills(character: Character): Skill[];
  
  // 習得条件チェック
  checkLearnCondition(character: Character, skill: Skill): LearnConditionCheck;
  
  // スキル習得
  learnSkill(character: Character, skill: Skill): LearnResult;
}
```

### Core Engine 委譲

- `character/skill.checkSkillLearnCondition()` - 習得条件判定
- `character/skill.getLearnableSkills()` - 習得可能スキル取得

### 実装例

```typescript
class SkillLearnService {
  constructor(private coreEngine: CoreEngine) {}
  
  getLearnableSkills(character: Character): Skill[] {
    // Core Engineから習得可能なスキルを取得
    return this.coreEngine.getLearnableSkills(character);
  }
  
  checkLearnCondition(character: Character, skill: Skill): LearnConditionCheck {
    // Core Engineで条件チェック
    const conditionCheck = this.coreEngine.checkSkillLearnCondition(character, skill);
    
    return {
      canLearn: conditionCheck.canLearn,
      missingConditions: conditionCheck.missingConditions,
      cost: conditionCheck.cost
    };
  }
  
  learnSkill(character: Character, skill: Skill): LearnResult {
    // 条件チェック
    const check = this.checkLearnCondition(character, skill);
    if (!check.canLearn) {
      return {
        success: false,
        message: '習得条件を満たしていません',
        missingConditions: check.missingConditions
      };
    }
    
    // スキルポイント・コスト消費
    if (check.cost > 0) {
      if (character.skillPoints < check.cost) {
        return {
          success: false,
          message: 'スキルポイントが不足しています'
        };
      }
      character.skillPoints -= check.cost;
    }
    
    // スキルを習得
    character.skills.push(skill);
    
    return {
      success: true,
      message: `${skill.name}を習得しました！`,
      learnedSkill: skill
    };
  }
}
```



---

## Headless UI層

---

## 8. SkillLearnController - スキル習得UI制御

### 状態定義

```typescript
interface SkillLearnUIState {
  // 対象キャラクター
  character: Character | null;
  
  // 選択段階
  stage: 'selecting-skill' | 'confirming' | 'completed';
  
  // スキル
  learnableSkills: Skill[];
  selectedSkill: Skill | null;
  
  // 条件
  learnCondition: LearnConditionCheck | null;
  
  // コスト
  cost: SkillLearnCost | null;
  
  // カーソル
  cursorIndex: number;
  
  // 結果
  result: LearnResult | null;
}

interface LearnConditionCheck {
  skill: Skill;
  canLearn: boolean;
  conditions: {
    type: 'level' | 'job' | 'prerequisite' | 'cost';
    met: boolean;
    requirement: string;
    current: string;
  }[];
}

interface SkillLearnCost {
  skillPoints?: number;
  money?: number;
  items?: { item: Item; quantity: number }[];
}

interface LearnResult {
  success: boolean;
  character: Character;
  skill: Skill;
  message: string;
}
```

### コントローラー実装

```typescript
type SkillLearnEvents = {
  'skill-selected': { skill: Skill };
  'skill-learned': { result: LearnResult };
  'cancelled': {};
};

class SkillLearnController {
  private state: ObservableState<SkillLearnUIState>;
  private events: EventEmitter<SkillLearnEvents>;
  private service: SkillLearnService;
  
  constructor(service: SkillLearnService) {
    this.service = service;
    this.state = new ObservableState<SkillLearnUIState>({
      character: null,
      stage: 'selecting-skill',
      learnableSkills: [],
      selectedSkill: null,
      learnCondition: null,
      cost: null,
      cursorIndex: 0,
      result: null
    });
    this.events = new EventEmitter<SkillLearnEvents>();
  }
  
  subscribe(listener: (state: SkillLearnUIState) => void): () => void {
    return this.state.subscribe(listener);
  }
  
  on<K extends keyof SkillLearnEvents>(
    event: K,
    listener: (data: SkillLearnEvents[K]) => void
  ): () => void {
    return this.events.on(event, listener);
  }
  
  // スキル習得開始
  startSkillLearn(character: Character): void {
    const learnableSkills = this.service.getLearnableSkills(character);
    
    this.state.setState({
      character,
      stage: 'selecting-skill',
      learnableSkills,
      selectedSkill: null,
      learnCondition: null,
      cost: null,
      cursorIndex: 0,
      result: null
    });
  }
  
  // スキル選択
  selectSkill(skill: Skill): void {
    const character = this.state.getState().character!;
    
    // 習得条件チェック
    const condition = this.service.checkLearnCondition(character, skill);
    
    // コスト計算
    const cost = this.calculateCost(skill);
    
    this.state.setState(prev => ({
      ...prev,
      selectedSkill: skill,
      learnCondition: condition as LearnConditionCheck,
      cost
    }));
    
    this.events.emit('skill-selected', { skill });
  }
  
  // 確認画面へ
  moveToConfirming(): void {
    this.state.setState(prev => ({
      ...prev,
      stage: 'confirming'
    }));
  }
  
  // スキル習得実行
  async learnSkill(): Promise<void> {
    const character = this.state.getState().character!;
    const skill = this.state.getState().selectedSkill!;
    
    const result = this.service.learnSkill(character, skill);
    
    this.state.setState(prev => ({
      ...prev,
      stage: 'completed',
      result: result as LearnResult
    }));
    
    this.events.emit('skill-learned', { result: result as LearnResult });
  }
  
  // カーソル移動
  moveCursor(delta: number): void {
    const maxIndex = this.state.getState().learnableSkills.length - 1;
    const currentIndex = this.state.getState().cursorIndex;
    const newIndex = Math.max(0, Math.min(maxIndex, currentIndex + delta));
    
    this.state.setState(prev => ({
      ...prev,
      cursorIndex: newIndex
    }));
  }
  
  // キャンセル
  cancel(): void {
    const currentState = this.state.getState();
    
    if (currentState.stage === 'confirming') {
      this.state.setState(prev => ({
        ...prev,
        stage: 'selecting-skill'
      }));
    } else {
      this.events.emit('cancelled', {});
    }
  }
  
  // コスト計算
  private calculateCost(skill: Skill): SkillLearnCost {
    return {
      skillPoints: skill.learnCost?.skillPoints || 0,
      money: skill.learnCost?.money || 0,
      items: skill.learnCost?.items || []
    };
  }
}
```



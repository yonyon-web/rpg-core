# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

æˆ¦é—˜ã‚„æˆé•·ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã«é–¢ã™ã‚‹è¨­è¨ˆã€‚Core Engineã€Serviceã®2å±¤ã§æ§‹æˆã€‚

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [Core Engineå±¤](#core-engineå±¤)
3. [Serviceå±¤](#serviceå±¤)

---

## æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ ã®å½¹å‰²

ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š

- **æˆ¦é—˜ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: è‡ªå‹•æˆ¦é—˜ã®å®Ÿè¡Œã¨çµæœäºˆæ¸¬
- **ç¢ºç‡è¨ˆç®—**: å„ç¨®åˆ¤å®šã®ç¢ºç‡ã¨æœŸå¾…å€¤ã®ç®—å‡º
- **ãƒ€ãƒ¡ãƒ¼ã‚¸æœŸå¾…å€¤**: å¹³å‡ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è¾¼ã¿ã®æœŸå¾…å€¤è¨ˆç®—

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service Layer                      â”‚
â”‚  SimulationService                  â”‚  â† ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ å§”è­²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Core Engine Layer                  â”‚
â”‚  ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«          â”‚  â† ç´”ç²‹ãªè¨ˆç®—
â”‚  - æˆ¦é—˜ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ                  â”‚
â”‚  - ç¢ºç‡è¨ˆç®—                          â”‚
â”‚  - æœŸå¾…å€¤ç®—å‡º                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Core Engineå±¤

### ğŸ¯ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨åˆ†æ

#### æˆ¦é—˜ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
- è‡ªå‹•æˆ¦é—˜ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- AIè¡Œå‹•ã®æ±ºå®š
- æˆ¦é—˜çµæœã®äºˆæ¸¬

#### ç¢ºç‡è¨ˆç®—
- å„ç¨®åˆ¤å®šã®ç¢ºç‡è¨ˆç®—
- æœŸå¾…å€¤ã®ç®—å‡º
- åˆ†æ•£ã®è¨ˆç®—

#### ãƒ€ãƒ¡ãƒ¼ã‚¸æœŸå¾…å€¤ã®è¨ˆç®—
- å¹³å‡ãƒ€ãƒ¡ãƒ¼ã‚¸ã®ç®—å‡º
- ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è¾¼ã¿ã®æœŸå¾…å€¤
- æœ€å¤§/æœ€å°ãƒ€ãƒ¡ãƒ¼ã‚¸ã®è¨ˆç®—



---

## Serviceå±¤

## 16. SimulationService - æˆ¦é—˜ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### æ¦‚è¦
æˆ¦é—˜çµæœã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€å‹ç‡ã‚„æœŸå¾…ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—ã€‚

### å…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```typescript
class SimulationService {
  // æˆ¦é—˜ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  simulateBattle(party: Character[], enemies: Enemy[], iterations: number): SimulationResult;
  
  // ãƒ€ãƒ¡ãƒ¼ã‚¸æœŸå¾…å€¤è¨ˆç®—
  calculateExpectedDamage(attacker: Combatant, target: Combatant, skill: Skill): number;
  
  // å‹ç‡è¨ˆç®—
  calculateWinRate(party: Character[], enemies: Enemy[]): number;
}
```

### Core Engine å§”è­²
- ã»ã¼ã™ã¹ã¦ã®Core Engineæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦æˆ¦é—˜ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ

### å®Ÿè£…ä¾‹

```typescript
class SimulationService {
  constructor(private coreEngine: CoreEngine) {}
  
  simulateBattle(party: Character[], enemies: Enemy[], iterations: number = 1000): SimulationResult {
    let victories = 0;
    let defeats = 0;
    let totalTurns = 0;
    const damageDealt: number[] = [];
    const damageTaken: number[] = [];
    
    for (let i = 0; i < iterations; i++) {
      // ãƒ‘ãƒ¼ãƒ†ã‚£ã¨æ•µã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
      const partyCopy = party.map(c => ({ ...c, currentHp: c.stats.maxHp, currentMp: c.stats.maxMp }));
      const enemiesCopy = enemies.map(e => ({ ...e, currentHp: e.stats.maxHp, currentMp: e.stats.maxMp }));
      
      // 1å›ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      const battleResult = this.simulateSingleBattle(partyCopy, enemiesCopy);
      
      if (battleResult.victory) {
        victories++;
      } else {
        defeats++;
      }
      
      totalTurns += battleResult.turns;
      damageDealt.push(battleResult.totalDamageDealt);
      damageTaken.push(battleResult.totalDamageTaken);
    }
    
    return {
      winRate: victories / iterations,
      averageTurns: totalTurns / iterations,
      averageDamageDealt: damageDealt.reduce((a, b) => a + b, 0) / iterations,
      averageDamageTaken: damageTaken.reduce((a, b) => a + b, 0) / iterations,
      iterations
    };
  }
  
  private simulateSingleBattle(party: Character[], enemies: Enemy[]): SingleBattleResult {
    let turns = 0;
    let totalDamageDealt = 0;
    let totalDamageTaken = 0;
    const maxTurns = 100; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
    
    while (turns < maxTurns) {
      turns++;
      
      // ã‚¿ãƒ¼ãƒ³é †åºè¨ˆç®—
      const turnOrder = this.coreEngine.calculateTurnOrder([...party, ...enemies]);
      
      for (const combatant of turnOrder) {
        // è¡Œå‹•ä¸èƒ½ãƒã‚§ãƒƒã‚¯
        const canAct = this.coreEngine.checkCanAct(combatant);
        if (!canAct) continue;
        
        // è¡Œå‹•é¸æŠ
        let action: BattleAction;
        if ('aiStrategy' in combatant) {
          // æ•µã®è¡Œå‹•
          const targets = party.filter(c => c.currentHp > 0);
          if (targets.length === 0) break;
          
          const skill = combatant.skills[Math.floor(Math.random() * combatant.skills.length)];
          action = {
            actor: combatant as Enemy,
            type: 'skill',
            skill,
            targets: [targets[Math.floor(Math.random() * targets.length)]]
          };
        } else {
          // å‘³æ–¹ã®è¡Œå‹•ï¼ˆç°¡æ˜“AIï¼‰
          const targets = enemies.filter(e => e.currentHp > 0);
          if (targets.length === 0) break;
          
          const skill = combatant.skills[0] || { type: 'physical-attack' };
          action = {
            actor: combatant as Character,
            type: 'skill',
            skill,
            targets: [targets[0]]
          };
        }
        
        // è¡Œå‹•å®Ÿè¡Œ
        const result = this.coreEngine.executeAction(action);
        
        // ãƒ€ãƒ¡ãƒ¼ã‚¸é›†è¨ˆ
        if ('aiStrategy' in combatant) {
          totalDamageTaken += result.totalDamage || 0;
        } else {
          totalDamageDealt += result.totalDamage || 0;
        }
        
        // å‹æ•—åˆ¤å®š
        const aliveParty = party.filter(c => c.currentHp > 0).length;
        const aliveEnemies = enemies.filter(e => e.currentHp > 0).length;
        
        if (aliveEnemies === 0) {
          return {
            victory: true,
            turns,
            totalDamageDealt,
            totalDamageTaken
          };
        }
        
        if (aliveParty === 0) {
          return {
            victory: false,
            turns,
            totalDamageDealt,
            totalDamageTaken
          };
        }
      }
    }
    
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆå¼•ãåˆ†ã‘æ‰±ã„ï¼‰
    return {
      victory: false,
      turns,
      totalDamageDealt,
      totalDamageTaken
    };
  }
  
  calculateExpectedDamage(attacker: Combatant, target: Combatant, skill: Skill): number {
    // Core Engineã§æœŸå¾…ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—
    return this.coreEngine.calculateExpectedDamage(attacker, target, skill);
  }
  
  calculateWinRate(party: Character[], enemies: Enemy[]): number {
    // ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ100å›ï¼‰
    const result = this.simulateBattle(party, enemies, 100);
    return result.winRate;
  }
}

interface SingleBattleResult {
  victory: boolean;
  turns: number;
  totalDamageDealt: number;
  totalDamageTaken: number;
}
```

---

## ã¾ã¨ã‚

### Serviceå®Ÿè£…ã®å„ªå…ˆé †ä½

**ãƒ•ã‚§ãƒ¼ã‚º1: æˆ¦é—˜ã®åŸºç¤**
1. BattleService
2. CommandService
3. EnemyAIService
4. EnemyGroupService
5. StatusEffectService

**ãƒ•ã‚§ãƒ¼ã‚º2: æˆé•·ã¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**
6. RewardService
7. EquipmentService
8. PartyService
9. SkillLearnService
10. JobChangeService

**ãƒ•ã‚§ãƒ¼ã‚º3: ç™ºå±•çš„æ©Ÿèƒ½**
11. ItemService
12. CraftService
13. EnhanceService
14. SaveLoadService
15. SimulationService

### Serviceé–“ã®ä¾å­˜é–¢ä¿‚

```
BattleService
â”œâ”€depends onâ†’ CommandService
â”œâ”€depends onâ†’ EnemyAIService
â”œâ”€depends onâ†’ StatusEffectService
â””â”€depends onâ†’ RewardService (æˆ¦é—˜çµ‚äº†æ™‚)

RewardService
â””â”€depends onâ†’ SkillLearnService (ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚)

CommandService
â””â”€depends onâ†’ ItemService (ã‚¢ã‚¤ãƒ†ãƒ é¸æŠæ™‚)

PartyService
â””â”€depends onâ†’ EquipmentService (ãƒ¡ãƒ³ãƒãƒ¼å¤‰æ›´æ™‚)
```

### å…±é€šè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

ã™ã¹ã¦ã®Serviceã¯ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã„ã¾ã™ï¼š

1. **çŠ¶æ…‹ç®¡ç†**: ç¾åœ¨ã®å‡¦ç†æ®µéšã‚’ä¿æŒ
2. **Core Engineå§”è­²**: è¨ˆç®—ã¨ãƒ«ãƒ¼ãƒ«åˆ¤å®šã¯Core Engineã«å§”è­²
3. **å‹å®‰å…¨**: TypeScriptã®å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ´»ç”¨
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ä¸æ­£ãªçŠ¶æ…‹é·ç§»ã‚’é˜²ã
5. **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: ä¾å­˜æ³¨å…¥ã«ã‚ˆã‚Šãƒ†ã‚¹ãƒˆå®¹æ˜“

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€rpg-coreãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®15ã®Serviceã‚’ä¸€è²«æ€§ã‚’æŒã£ã¦å®Ÿè£…ã§ãã¾ã™ã€‚

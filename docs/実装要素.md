# 実装要素一覧

rpg-coreライブラリで実装する要素をまとめたドキュメント

## このライブラリが目指すもの

> **JRPGにおける「戦闘・成長・管理・敵行動」のよくある操作フローを、UIや世界に依存しない Service 群として提供する**

このライブラリは「プレイヤーと敵を含むJRPGの操作フロー」を再利用可能な Service 群として提供するための基盤です。

## スコープ

### ❌ 扱わないもの
- 世界・マップ・シナリオ
- 会話・演出・カメラ
- 描画・アニメーション・サウンド
- 座標・物理・移動

### ✅ 扱うもの
- プレイヤーキャラと敵の数値・状態
- 戦闘とその前後の流れ
- 成長・装備・クラフト
- JRPG特有の操作体験
- 状態管理と永続化

## 全体アーキテクチャ

```text
UI（見た目・入力）
  ↓
Headless UI（選択・確認・キャンセル）
  ↓
JRPG Services（操作フロー）
  ↓
Core Engine（数値・ルール）
  ↓
Game State（永続可能な状態）
```

## Service 共通の性質

すべての Service は以下の特性を持ちます：

- **複数ステップの進行を持つ**: 戦闘開始→コマンド選択→実行→結果のような流れ
- **状態を持ち、中断・再開できる**: セーブ/ロード対応
- **UIに依存しない**: Headless UI から操作される
- **数値計算やルールは持たない**: Core Engine に委譲
- **操作フローの管理に特化**: 選択肢の提示、決定、キャンセルの流れを管理

## 目次

### 🎮 戦闘・操作に関する機能
1. [戦闘](./features/戦闘.md) - 戦闘全体の進行とコマンド選択
2. [アイテム](./features/アイテム.md) - アイテム使用の流れ

### 🧠 敵に関する機能
3. [敵AI](./features/敵AI.md) - 敵の行動決定とグループ管理

### 📈 成長・キャラクターに関する機能
4. [キャラクター成長](./features/キャラクター成長.md) - 経験値とレベルアップ
5. [スキル習得](./features/スキル習得.md) - スキル習得の流れ
6. [ジョブ変更](./features/ジョブ変更.md) - 職業・クラス変更
7. [報酬](./features/報酬.md) - 戦闘やイベントの報酬処理

### 🎒 管理・編成に関する機能
8. [インベントリ](./features/インベントリ.md) - アイテムとバッグの管理
9. [装備](./features/装備.md) - 装備の変更管理
10. [パーティ編成](./features/パーティ編成.md) - パーティ編成管理
11. [状態異常](./features/状態異常.md) - 状態異常・バフ・デバフ管理

### 🛠 クラフト・育成に関する機能
12. [クラフト](./features/クラフト.md) - アイテム合成の流れ
13. [強化](./features/強化.md) - 装備やキャラクターの強化

### 💾 システム・支援に関する機能
14. [セーブロード](./features/セーブロード.md) - セーブとロードの流れ
15. [データ永続化](./features/データ永続化.md) - ゲーム状態の永続化
16. [シミュレーション](./features/シミュレーション.md) - 戦闘や成長のシミュレーション

---

## 🎮 戦闘・操作に関する Service

### 戦闘全体の進行を管理する Service

#### 役割
戦闘開始から終了までを管理し、プレイヤー操作フェーズと敵行動フェーズを切り替える。

#### 操作フロー
1. 戦闘開始の初期化
2. ターンの開始
3. プレイヤーフェーズ（コマンド選択待ち）
4. 敵行動フェーズ（AI による自動実行）
5. ターン終了処理（状態異常のターン経過など）
6. 勝利/敗北/逃走判定
7. 戦闘終了

#### Service が管理する状態
- 現在のフェーズ（初期化/プレイヤーターン/敵ターン/終了）
- 行動順リスト
- ターンカウント
- 戦闘参加者（味方パーティ、敵グループ）
- 戦闘結果（勝利/敗北/逃走）

#### Core Engine への委譲
- 行動順の計算（素早さに基づく）
- ダメージ計算
- 勝利条件・敗北条件の判定

---

### 戦闘中のコマンド選択を扱う Service

#### 役割
攻撃・スキル・アイテム・防御などの選択肢提示、決定、キャンセルを管理する。

#### 操作フロー
1. 行動可能なキャラクターの特定
2. 利用可能なコマンドの列挙（攻撃/スキル/アイテム/防御/逃走）
3. コマンドの選択
4. 対象の選択（単体/全体/自分など）
5. 確認・キャンセル処理
6. 行動の確定

#### Service が管理する状態
- 現在のコマンド選択段階（コマンド選択/対象選択/確認）
- 選択中のキャラクター
- 選択されたコマンド
- 選択された対象
- 確定済み行動のキュー

#### Core Engine への委譲
- コマンドの使用可否判定（MP不足、状態異常など）
- 対象候補の列挙
- コマンドの実行

---

### アイテム使用の流れを扱う Service

#### 役割
使用するアイテムの選択、対象選択、効果適用までの一連の流れを管理する。

#### 操作フロー
1. インベントリから使用可能アイテムの表示
2. アイテムの選択
3. 使用可能状況の確認（戦闘中/フィールド）
4. 対象の選択
5. 効果の適用
6. アイテム数の減少
7. 結果の表示

#### Service が管理する状態
- 現在のアイテム選択段階（アイテム選択/対象選択/確認）
- 選択されたアイテム
- 選択された対象
- アイテムの使用結果

#### Core Engine への委譲
- アイテムの効果計算
- 使用可能条件の判定
- インベントリの更新

---

## 🧠 敵に関する Service

### 敵の行動を自動決定する Service

#### 役割
敵のスキル選択や対象選択を条件・重み・AIルールに基づいて決定する。

#### 操作フロー
1. 行動する敵の特定
2. 戦況の分析（味方のHP状況、状態異常など）
3. AIルールに基づく行動の決定
4. 対象の決定
5. 行動の実行

#### Service が管理する状態
- 敵のAI設定（行動パターン、優先度）
- 現在の思考状態
- 決定された行動

#### Core Engine への委譲
- 使用可能なスキルの列挙
- 対象候補の評価
- 行動の実行

---

### 複数の敵をひとまとまりとして扱う Service

#### 役割
敵の並び、出現、全滅判定など敵グループ全体の管理を行う。

#### 操作フロー
1. 敵グループの編成
2. 敵の配置（前列/後列）
3. 戦闘開始時の初期化
4. 敵の撃破管理
5. 全滅判定
6. ドロップアイテムの決定

#### Service が管理する状態
- 敵グループの構成
- 各敵の配置位置
- 生存している敵のリスト
- ドロップアイテム候補

#### Core Engine への委譲
- 敵の初期ステータス設定
- ドロップ判定の計算

---

## 📈 成長・キャラクターに関する Service

### スキル習得の流れを管理する Service

#### 役割
レベルアップ時や特定条件下で習得可能スキルの提示と選択を管理する。

#### 操作フロー
1. 習得可能スキルの判定
2. スキルリストの提示
3. スキルの選択
4. 習得の確定
5. キャラクターへのスキル追加

#### Service が管理する状態
- 習得可能なスキルリスト
- 選択中のスキル
- 習得済みスキル

#### Core Engine への委譲
- 習得条件の判定（レベル、ジョブなど）
- スキルデータの管理

---

### 職業・クラス変更の流れを管理する Service

#### 役割
転職条件の確認、ステータスやスキルの再計算を行う。

#### 操作フロー
1. 変更可能な職業の列挙
2. 職業の選択
3. 転職条件の確認
4. 転職の確定
5. ステータスの再計算
6. 装備の再チェック（装備不可になった装備の処理）
7. スキルの更新

#### Service が管理する状態
- 現在の職業
- 変更可能な職業リスト
- 選択中の職業
- 転職履歴

#### Core Engine への委譲
- 転職条件の判定
- ステータス補正の計算
- 装備可否の判定

---

### 戦闘やイベントの報酬を処理する Service

#### 役割
経験値・お金・ドロップアイテムの付与と、レベルアップ検出を行う。

#### 操作フロー
1. 報酬の計算（経験値、お金、アイテム）
2. パーティメンバーへの経験値配分
3. レベルアップの検出
4. レベルアップ処理の実行
5. 習得可能スキルの通知
6. アイテムの獲得
7. 結果の表示

#### Service が管理する状態
- 獲得した経験値
- 獲得したお金
- 獲得したアイテム
- レベルアップしたキャラクターのリスト

#### Core Engine への委譲
- 経験値の計算
- レベルアップ判定
- ステータス成長の計算

---

## 🎒 管理・編成に関する Service

### 装備の変更を管理する Service

#### 役割
装備可能判定、ステータス補正の反映を行う。

#### 操作フロー
1. 装備変更するキャラクターの選択
2. 装備スロットの選択（武器/防具/アクセサリー）
3. 装備可能なアイテムの列挙
4. 装備の選択
5. 装備条件の確認（レベル、ジョブ制限など）
6. 装備の確定
7. ステータスの再計算
8. 変更前後の比較表示

#### Service が管理する状態
- 選択中のキャラクター
- 選択中の装備スロット
- 現在の装備構成
- 候補となる装備リスト

#### Core Engine への委譲
- 装備可能条件の判定
- ステータス補正の計算
- 装備効果の適用

---

### パーティ編成を管理する Service

#### 役割
メンバーの入替、並び順や戦闘参加可否を管理する。

#### 操作フロー
1. 利用可能なキャラクターの表示
2. パーティメンバーの選択
3. 並び順の変更
4. 戦闘参加メンバーの指定
5. 編成の確定

#### Service が管理する状態
- 現在のパーティ構成
- 利用可能なキャラクターリスト
- 並び順
- 戦闘参加フラグ

#### Core Engine への委譲
- パーティ人数制限の管理
- メンバー変更による影響の計算

---

### 状態異常やバフ・デバフを管理する Service

#### 役割
付与・解除・ターン経過による更新を扱う。

#### 操作フロー
1. 状態異常の付与判定
2. 効果の適用
3. ターン経過による持続ターン減少
4. 効果の自動発動（毒ダメージなど）
5. 解除条件の判定
6. 状態異常の解除

#### Service が管理する状態
- 各キャラクターの状態異常リスト
- 各効果の持続ターン
- バフ/デバフのスタック状況

#### Core Engine への委譲
- 状態異常の付与判定（耐性、成功率）
- 効果の計算（ダメージ、ステータス変動）
- 解除条件の判定

---

## 🛠 クラフト・育成に関する Service

### アイテム合成の流れを管理する Service

#### 役割
レシピ選択、素材確認、合成結果の生成を行う。

#### 操作フロー
1. 利用可能なレシピの表示
2. レシピの選択
3. 必要素材の確認
4. 素材の所持チェック
5. 合成の実行
6. 成功/失敗の判定
7. 結果アイテムの獲得
8. 素材の消費

#### Service が管理する状態
- 習得済みレシピリスト
- 選択中のレシピ
- 合成結果
- 合成履歴

#### Core Engine への委譲
- 素材の所持チェック
- 成功率の計算
- 結果アイテムの生成
- インベントリの更新

---

### 装備やキャラクターの強化を管理する Service

#### 役割
強化内容の選択、成功・失敗判定、能力値変化の反映を行う。

#### 操作フロー
1. 強化対象の選択（装備/キャラクター）
2. 強化方法の選択
3. 必要素材・コストの確認
4. 強化の実行
5. 成功/失敗の判定
6. 能力値の変化
7. 結果の表示

#### Service が管理する状態
- 強化対象
- 強化レベル
- 強化履歴
- 強化結果

#### Core Engine への委譲
- 成功率の計算
- 能力値上昇の計算
- コストの消費処理

---

## 💾 システム・支援に関する Service

### セーブとロードの流れを管理する Service

#### 役割
セーブスロット管理、データバージョン対応を行う。

#### 操作フロー
1. セーブスロットの表示
2. スロットの選択
3. セーブデータの作成/読み込み
4. データのシリアライズ/デシリアライズ
5. バージョン互換性のチェック
6. 結果の確認

#### Service が管理する状態
- セーブスロット情報
- 現在のゲーム状態のスナップショット
- ロードされたゲーム状態

#### Core Engine への委譲
- ゲーム状態の永続化
- データバージョン管理

---

### 戦闘や成長のシミュレーションを行う Service

#### 役割
自動戦闘、勝率や期待値の算出など、バランス調整を支援する。

#### 操作フロー
1. シミュレーション条件の設定
2. 複数回の戦闘シミュレーション実行
3. 結果の集計
4. 統計データの出力
5. バランス評価の表示

#### Service が管理する状態
- シミュレーション設定
- 実行回数
- 結果の統計データ

#### Core Engine への委譲
- 戦闘ロジックの実行
- 確率計算
- ダメージ期待値の計算

---

## 実装優先度

### フェーズ1：戦闘の基礎
1. 戦闘全体の進行を管理する Service
2. 戦闘中のコマンド選択を扱う Service
3. 敵の行動を自動決定する Service
4. 複数の敵をひとまとまりとして扱う Service

### フェーズ2：成長と管理
1. 戦闘やイベントの報酬を処理する Service
2. 装備の変更を管理する Service
3. パーティ編成を管理する Service
4. 状態異常やバフ・デバフを管理する Service

### フェーズ3：発展的な機能
1. スキル習得の流れを管理する Service
2. 職業・クラス変更の流れを管理する Service
3. アイテム使用の流れを扱う Service

### フェーズ4：拡張機能
1. アイテム合成の流れを管理する Service
2. 装備やキャラクターの強化を管理する Service
3. セーブとロードの流れを管理する Service
4. 戦闘や成長のシミュレーションを行う Service

---

## 技術的考慮事項

### Service の設計原則
- **ステートマシンパターン**: 各 Service は複数の状態を持ち、状態遷移を管理
- **イベント駆動**: Core Engine からのイベントを受け取り、UI へ通知
- **永続化対応**: すべての Service の状態はシリアライズ可能
- **UIフリー**: 具体的な UI 実装に依存しない抽象的なインターフェース

### Core Engine との分離
- Service は「いつ・何を・どの順で」を管理
- Core Engine は「どのように計算するか」を担当
- Service から Core Engine への呼び出しは明確なインターフェースを通じて行う

### 状態管理
- 各 Service は独立した状態を持つ
- Game State は全 Service の状態を統合
- セーブデータは Game State のスナップショット

### テスト容易性
- UI を使わず Service のみでテスト可能
- モック Core Engine を使った単体テスト
- 統合テストでの操作フローの検証

---

## まとめ

このライブラリは、JRPGの操作フローを再利用可能な Service として提供します。

### 設計の核心
- **操作フロー重視**: 数値計算ではなく、選択→確認→実行の流れを管理
- **段階的な進行**: すべての操作は複数ステップで構成され、中断・再開が可能
- **UI非依存**: Headless UI を介して任意の UI から操作可能
- **永続化対応**: すべての状態はセーブ・ロード可能

### 利用イメージ
開発者はこれらの Service を組み合わせることで、JRPG特有の操作体験を素早く実装できます。
- Web UI、コンソール UI、モバイル UI など、どの UI からでも同じ Service を利用可能
- テストやシミュレーションもUI なしで実行可能
- ゲーム固有のルールは Core Engine をカスタマイズすることで実現

実装は優先度に従って段階的に進め、各フェーズで動作確認を行うことを推奨します。
